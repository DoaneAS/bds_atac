BigDataScript (BDS) tips
===================================================================

### Installation instruction for BDS

Check if BDS is already installed on a cluster.
```
$which bds
```

If not, install it locally on your home.
```
cd $HOME
wget -O bds_Linux.tgz https://github.com/pcingola/BigDataScript/releases/download/v0.999k/bds_Linux.tgz
tar zxvf bds_Linux.tgz
rm bds_Linux.tgz
```

Download bds.config.SERVERNAME on <a href="./_bds_config">./_bds_config</a>. Move it to your ${HOME}/.bds/bds.config. In bds.config, you can specify your information like email address to get job status notification from clusters.
```
clusterRunAdditionalArgs = -A accountID -M user@gmail.com
```

If you want to pass all of environment variables on your login shell to cluster job nodes, simply add -V to clusterRunAdditionalArgs.
```
clusterRunAdditionalArgs = -V
```

<b> Skip steps below if BDS is already installed on /bin or /usr/bin </b>

Add the following to ${HOME}/.bds/bds.config.
```
# This is an example, Do not use ${HOME} in bds.config. Write absolute path for your ${HOME}/.bds.
clusterRunAdditionalArgs = -v PATH=/users/leepc12/.bds
```

Also, modify your ${HOME}/.bashrc to add the following:
```
export PATH=${PATH}:${HOME}/.bds/
```

Official homepage for BDS is at <a href="http://pcingola.github.io/BigDataScript/download.html">http://pcingola.github.io/BigDataScript/download.html</a> and the git repo for BDS is at <a href="https://github.com/pcingola/BigDataScript.git">https://github.com/pcingola/BigDataScript.git</a>.


### Running BDS Script

Go to your working directory where BDS will produce ouputs.
```
$cd $WORK_DIR
```

Running locally,
```
$bds script.bds 
```

Running on a cluster with sun grid engine.
```
$bds -s sge script.bds 
```

Debugging, verbose (temp. files generated by BDS will not be removed with -noRmOnExit, -d for debugging and -v for verbose)
```
$bds -noRmOnExit -v -d script.bds
```

Note that there are two groups of parameters,
```
$bds [OPTS_FOR_BDS] script.bds [OPTS_FOR_YOUR_SCIRPT]
```

For detailed help for [OPTS_FOR_BDS],
```
$bds -h
```

For detailed help for [OPTS_FOR_YOUR_SCRIPT],
```
$bds script.bds -h
```

### BDS on Sun Grid Engine

Add the following to your SGE configuration to allow BDS kill jobs cleanly when you send CTRL-C signal to it. Without the following configruation, processes initiated by BDS will not be killed even thoug jobs are remove from queues (qstat). You may need sudo previlege for this.
```
$qconf -mconf
execd_params                 ENABLE_ADDGRP_KILL=true
```

### Modified version of BDS

The author of BDS is very responsive and supportive but more features like HTML progress report is needed. The BDS binary for that is in <a href="./_bds_bin/">./_bds_bin/</a>. The git repo for modified version of BDS is at <a href="https://github.com/kundajelab/BigDataScript">https://github.com/kundajelab/BigDataScript</a>. Try to clone from a git branch named "jin" to get the latest modification of BDS code. 
```
$git clone https://github.com/kundajelab/BigDataScript
$cd BigDataScript
$git pull jin
```

If you have a sudo privilege, I would recommend to move BDS binary to /usr/bin or /bin.
```
$sudo cp ./_bds_bin/bds /usr/bin/
```

Otherwise, add it to your local directory, do not forget to add it to your $PATH
```
$cp ./_bds_bin/bds ${HOME}/.bds/
```


### HTML progress report for BDS jobs (with BDS binary modified by Jin)

It is important to check your BDS job status real-time online. If you have a NFS mounted web directory (eg. /srv/www/kundaje/leepc12/job_status/) connected to your cluster, you can automatically synchronize all files on your working directory to the web directory.
```
./_tools/recursive_ln [SRC] [DEST]
```

recursive_ln.sh makes the same directory structure on [DEST] as in [SRC] then synchronize (with ln -s) all files (except some BDS system/temporary files) on [SRC] to [DEST]. Additionally it removes all dead soft links and empty directory under [DEST] to keep [DEST] small and simple.

You can use a cron job to automate this.
```
$crontab -e

# This is an example for nandi cluster. Sync important files every 5 minutes.
# Modify path for sync_bds_report.sh, SRC (top of your working directory) and DEST (web directory)

*/5 * * * * /users/leepc12/code/pipelines/bds/_tools/recursive_ln.sh /srv/scratch/leepc12/run /srv/www/kundaje/leepc12/bds_monitor/nandi
```

### Contributors

* Jin wook Lee - PhD Student, Mechanical Engineering Dept., Stanford University
* Anshul Kundaje - Assistant Professor, Dept. of Genetics, Stanford University
